-- Salt Personal Cheat Menu v3 (ESP Color + Fly Q/E Fixed)
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local camera = Workspace.CurrentCamera

local Settings = {
    Fly = false,
    FlySpeed = 50,
    Noclip = false,
    Speed = 16,
    InfiniteJump = false,
    ESP = false
}

local flyBodyVelocity, flyBodyAngular, noclipConnection
local espConnections = {}
local drawings = {boxes = {}, names = {}}

local sg = Instance.new("ScreenGui")
sg.Name = "SaltGUI"
sg.ResetOnSpawn = false
sg.Parent = game:GetService("CoreGui")

-- GUI (без изменений, только title v3)
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, 420)
mainFrame.Position = UDim2.new(0, 15, 0, 15)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = sg

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 45)
title.BackgroundTransparency = 1
title.Text = "Salt v3"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 32
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Center
title.Parent = mainFrame

-- Particles (без изменений)
local particles = {}
local particleData = {}
for i = 1, 80 do
    local part = Instance.new("Frame")
    part.Size = UDim2.new(0, 4, 0, 4)
    part.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    part.BackgroundTransparency = 0.5
    part.BorderSizePixel = 0
    part.ZIndex = 1
    part.Parent = mainFrame
    Instance.new("UICorner", part).CornerRadius = UDim.new(1, 0)
    part.Position = UDim2.new(math.random(), 0, math.random(), 0)
    table.insert(particles, part)
    particleData[part] = {phaseX = math.random()*math.pi*2, phaseY = math.random()*math.pi*2, speedX = (math.random()-0.5)*0.002, speedY = (math.random()-0.5)*0.002}
end

RunService.RenderStepped:Connect(function()
    for _, part in particles do
        local d = particleData[part]
        d.phaseX += d.speedX
        d.phaseY += d.speedY
        local x = 0.1 + math.sin(d.phaseX)*0.4
        local y = 0.1 + math.cos(d.phaseY)*0.4
        part.Position = UDim2.new(x, 0, y, 0)
        part.BackgroundTransparency = 0.3 + math.sin(tick()*4 + d.phaseX)*0.3
    end
end)

-- Toggle / Slider функции (без изменений, пропущены для краткости, используй те же из v2)

-- === FIXED FLY ===
local function toggleFly(enabled)
    Settings.Fly = enabled
    local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    if enabled then
        flyBodyVelocity = Instance.new("BodyVelocity")
        flyBodyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
        flyBodyVelocity.Velocity = Vector3.new(0,0.1,0)
        flyBodyVelocity.Parent = root

        flyBodyAngular = Instance.new("BodyAngularVelocity")
        flyBodyAngular.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
        flyBodyAngular.AngularVelocity = Vector3.new(0,0,0)
        flyBodyAngular.Parent = root
    else
        if flyBodyVelocity then flyBodyVelocity:Destroy() end
        if flyBodyAngular then flyBodyAngular:Destroy() end
        flyBodyVelocity, flyBodyAngular = nil, nil
    end
end

RunService.RenderStepped:Connect(function()
    if Settings.Fly and flyBodyVelocity then
        local root = player.Character and player.Character.HumanoidRootPart
        if not root then return end
        local move = Vector3.new()
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then move += camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then move -= camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then move -= camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then move += camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.E) or UserInputService:IsKeyDown(Enum.KeyCode.Space) then move += Vector3.new(0,1,0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.Q) or UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then move -= Vector3.new(0,1,0) end

        if move.Magnitude > 0 then move = move.Unit end
        flyBodyVelocity.Velocity = move * Settings.FlySpeed
    end
end)

-- === FIXED ESP ===
local function cleanupESP(plr)
    if drawings.boxes[plr] then drawings.boxes[plr]:Remove() drawings.boxes[plr] = nil end
    if drawings.names[plr] then drawings.names[plr]:Remove() drawings.names[plr] = nil end
end

local function toggleESP(enabled)
    Settings.ESP = enabled
    for _, conn in espConnections do conn:Disconnect() end
    espConnections = {}

    if not enabled then
        for plr,_ in drawings.boxes do cleanupESP(plr) end
        return
    end

    espConnections.update = RunService.Heartbeat:Connect(function()  -- 60 FPS max
        for _, plr in Players:GetPlayers() do
            if plr == player or not plr.Character then 
                cleanupESP(plr)
                continue 
            end
            local root = plr.Character:FindFirstChild("HumanoidRootPart")
            local head = plr.Character:FindFirstChild("Head")
            local hum = plr.Character:FindFirstChild("Humanoid")
            if not (root and head and hum and hum.Health > 0) then 
                cleanupESP(plr)
                continue 
            end

            local rootPos = root.Position
            local _, onScreen = camera:WorldToViewportPoint(rootPos)

            -- Raycast LOS
            local ray = Ray.new(camera.CFrame.Position, (rootPos - camera.CFrame.Position).Unit * 500)
            local hit, _ = Workspace:FindPartOnRayWithIgnoreList(ray, {camera, plr.Character})

            local color = (onScreen and not hit) and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)

            -- Box
            if not drawings.boxes[plr] then drawings.boxes[plr] = Drawing.new("Quad") end
            local box = drawings.boxes[plr]
            local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0,0.5,0))
            local legPos = camera:WorldToViewportPoint(rootPos - Vector3.new(0,4,0))
            local height = math.abs(headPos.Y - legPos.Y)
            local width = height * 0.45

            box.PointA = Vector2.new(headPos.X - width/2, headPos.Y)
            box.PointB = Vector2.new(headPos.X + width/2, headPos.Y)
            box.PointC = Vector2.new(headPos.X + width/2, legPos.Y)
            box.PointD = Vector2.new(headPos.X - width/2, legPos.Y)
            box.Color = color
            box.Thickness = 2
            box.Transparency = 1
            box.Visible = onScreen

            -- Name + Dist
            local dist = math.floor((player.Character.HumanoidRootPart.Position - rootPos).Magnitude)
            if not drawings.names[plr] then drawings.names[plr] = Drawing.new("Text") end
            local txt = drawings.names[plr]
            txt.Text = plr.Name .. "\n[" .. dist .. "m]"
            txt.Position = Vector2.new(headPos.X, headPos.Y - 25)
            txt.Size = 15
            txt.Color = color
            txt.Center = true
            txt.Outline = true
            txt.Visible = onScreen
        end
    end)
end

-- Cleanup
Players.PlayerRemoving:Connect(cleanupESP)
player.CharacterRemoving:Connect(function() for plr,_ in drawings.boxes do cleanupESP(plr) end end)

-- Остальные функции (Noclip, Speed, InfiniteJump) — как в v2

print("Salt v3 загружен! ESP цвет + Fly Q/E fixed")
